{% extends 'd2api/base.html' %}

{% block title %}DESTINY 2 - TAKE A LOOK{% endblock title %}

{% load static %}
{% block style %}
{% endblock style %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script>
    function getManifest() {
        $.ajax({
            url: "{% url 'd2api:get_manifest' %}"
        }).done(function (res) {
            console.log("success");
        }).fail(function (e) {
            console.log("error");
            console.log(e);
        });
    }

    let accessToken = "";

    function getAuth() {
        $.ajax({
            url: "{% url 'd2api:get_auth' %}"
        }).done(function (res) {
            location.href = res['authorization_url'];
        }).fail(function (e) {
            console.log(e);
        });
    }

    function fetchToken() {
        $.ajax({
            url: "{% url 'd2api:fetch_token' %}",
            type: "post",
            data: JSON.stringify({
                'auth_res': location.search
            }),
            headers: {
                'X-CSRFTOKEN': "{{ csrf_token }}"
            }
        }).done(function (res) {
            console.log(res);
            accessToken = res['access_token'];
        }).fail(function (e) {
            console.log(e);
        });
    }
    
    function getData() {
        $.ajax({
            url: "{% url 'd2api:get_data' %}"
        }).done(function (res) {
            console.log("success");
            console.log(res);
        }).fail(function (e) {
            console.log("error");
            console.log(e);
        });
    }
</script>
{% endblock script %}

{% block body %}
<h1>DESTINY 2 - TAKE A LOOK</h1>
<fieldset>
    <legend>Manifest</legend>
    <button onclick="getManifest();">Get Manifest</button>
</fieldset>
<fieldset>
    <legend>Authentication</legend>
    <button onclick="getAuth();">Get Authorization</button>
    <button onclick="fetchToken();">Fetch Token</button>
</fieldset>
<button onclick="getData();">Get Data</button>
{% endblock body %}